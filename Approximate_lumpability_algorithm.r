
lumpability_2 <- function(n,Q,C,B,P)  #INPUT SHOULD BE ARRAY WITH M+1 VALUES TO INCLUDE LAST STATE OF ORIGINAL CHAIN +1 EX : 6 STATES TO BE LUMPED AS BELOW Q=(1,4,6,7)
{
  m <- length(Q)
  partition = Q
  
  A <- matrix(NaN, nrow=(m-1)*(n-m+1)+n, ncol=n^2)
  p <- reparameterization(P)
  Arow <- 1
  
  CONDITION <- matrix(0, nrow = n, ncol =n)
  CONDITION[1,] <- C 
  
  b <- matrix(0,nrow=(m-1)*(n-m+1)+n, ncol=1)
  b[((m-1)*(n-m+1)+1):((m-1)*(n-m+1)+n),] <- t(B)
  
  
  for (k in 2:m)
  {
    L <- matrix(0, nrow=n, ncol=n)
    
    L[1,partition[k-1]:(partition[k]-1)] <- 1
    L[2,partition[k-1]:(partition[k]-1)] <- -1
    
    iterations <- 1
    
    while (iterations <= (n-1))
    {
      for (i in 2:m)
      {
        if (iterations >= partition[i-1] && (iterations +1) <= (partition[i]-1))  #check to see if we accept this combination of states
        {
          A[Arow,] <- reparameterization(L)
          Arow <- Arow + 1
          i <- m
          break
        }
      }
      
      L <- L[c(n,1:(n-1)),]
      
      iterations <- iterations +1
      
    }
    
    Arowcond <- (m-1)*(n-m+1)+1
    
    while (Arowcond <= (m-1)*(n-m+1)+n)
    {
      A[Arowcond,] <- reparameterization(CONDITION)
      CONDITION <- CONDITION[c(n,1:(n-1)),]
      Arowcond <-Arowcond + 1
    }
    
  }
  
  matrixrepar(MASS::ginv(A)%*%(b-A%*%p)+p)
}





itproj<-function(P,maxstep,Q,C,B)
{
  n <- nrow(P)
  P_L<- lumpability_2(n,Q,C,B,P)
  step <- 1
  
      while (step <= maxstep)
       {
            P_L<- P_L*(P_L>0)
            P_L <- lumpability_2(n,Q,C,B,P_L)
            step <- step + 1
              
        }
  
  return(P_L)
}





dykstralg<-function(P,maxstep,Q,C,B)
{
  
  x <- P
  p <- matrix(0, nrow=nrow(P),ncol=ncol(P))
  q <- matrix(0, nrow=nrow(P),ncol=ncol(P)) 
  
  n <- nrow(P)
  step <- 1
  
  while (step <= maxstep)
  {
    
    y <- (x+p)*(x+p>0)
    p <- x + p - y 
    x <- lumpability_2(n,Q,C,B,y+q)
    q <- y + q - x
    
    step <- step + 1 
  }

  
  return(x)
}



Pcr <- matrix(0,nrow=9,ncol=9)
Pcr[1:3,1] <-c(89.6,0.9,0.2)
Pcr[1:6,2] <- c(10,88.3,2.7,0.3,0.1,0.2)
Pcr[1:6,3] <- c(0.4,10.7,91.1,6.6,0.5,0.2)
Pcr[2:7,4] <-c(0.1,5.6,86.8,5.9,0.8,0.8)
Pcr[3:7,5] <- c(0.4,5.6,83.1,6.6,1.9)
Pcr[4:8,6] <- c(0.4,8.4,79.6,9.3,5.9)
Pcr[4:8,7] <- c(0.2,0.3,2.2,63,5.9)
Pcr[6:8,8] <- c(1,1.9,64.7)
Pcr[4:9,9] <- c(0.1,1.7,9.4,23.1,23.5,100)

Pfinal <- Pcr/100
Q=c(1,4,9,10)
B=rep(1,9)

P_lumped <- lumpability_2(9,Q,C,B,Pfinal)
Pfinal_lumpable <- dykstralg(P_lumped, 60, Q,C,B)

V<-cbind(c(1,1,1,0,0,0,0,0,0),c(0,0,0,1,1,1,1,1,0),c(0,0,0,0,0,0,0,0,1))
U <- rbind(c(1/3,1/3,1/3,0,0,0,0,0,0),c(0,0,0,1/5,1/5,1/5,1/5,1/5,0),c(0,0,0,0,0,0,0,0,1))

V%*%U%*%Pfinal%*%V
Pfinal%*%V

Pnew <- U%*%Pfinal_lumpable%*%V

A <- rbind(c(-1/2,-1/2,0,1/2,1/2,0,0,0,0),c(0,0,-1/2,0,0,1/2,0,0,0),c(1/2,1/2,0,-1/2,-1/2,0,0,0,0),c(0,0,1/2,0,0,-1/2,0,0,0),
    c(0,0,0,0,0,0,0,0,0),c(0,0,0,0,0,0,0,0,0),c(1,1,1,0,0,0,0,0,0),c(0,0,0,1,1,1,0,0,0),c(0,0,0,0,0,0,1,1,1))
 

##Review Examples #######################################################################
moodys <- matrix(0, nrow=22, ncol=22)
moodys[1,1:22] <- c(0.9282,0.0602,0.0095, 0.0020, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0000,0.0000 ,0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0000 ,0.0000, 0.0000)
moodys[2,1:22] <- c(0.1798, 0.5654, 0.2088, 0.0438, 0.0014, 0.0007, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000)
moodys[3,1:22] <- c(0.0481, 0.0748, 0.8390, 0.0364, 0.0011, 0.0006, 0.0000, 0.0000 ,0.0000 ,0.0000, 0.0000 ,0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000, 0.0000)
moodys[4,1:22] <- c(0.0299, 0.0070, 0.1258, 0.7582, 0.0499, 0.0260, 0.0014, 0.0001, 0.0017, 0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000)
moodys[5,1:22] <- c(0.0017, 0.0003, 0.0076, 0.0945, 0.7895 ,0.0368, 0.0333, 0.0025, 0.0326, 0.0011, 0.0000 ,0.0000 ,0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000)
moodys[6,1:22] <- c(0.0005, 0.0001, 0.0021, 0.0273, 0.0707, 0.8211, 0.0258, 0.0033, 0.0475, 0.0015, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000, 0.0000)
moodys[7,1:22] <- c(0.0004, 0.0001 ,0.0019, 0.0248, 0.0278, 0.1143 ,0.8041, 0.0218, 0.0038, 0.0005, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000 ,0.0000, 0.0000, 0.0004)
moodys[8,1:22] <- c(0.0000, 0.0000, 0.0001, 0.0025, 0.0035, 0.0414, 0.1297, 0.7527, 0.0031, 0.0310, 0.0022, 0.0007, 0.0000, 0.0000, 0.0001, 0.0011, 0.0001, 0.0000, 0.0000, 0.0000, 0.0000, 0.0316)
moodys[9,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0009, 0.0017, 0.0301 ,0.0348 ,0.1002, 0.7759, 0.0515, 0.0016, 0.0011, 0.0000, 0.0000, 0.0000, 0.0001, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0021)
moodys[10,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0003, 0.0004, 0.0037, 0.0205, 0.0381, 0.0945, 0.7588, 0.0481, 0.0316, 0.0010, 0.0007, 0.0011, 0.0004, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0008)
moodys[11,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0001, 0.0001, 0.0012, 0.0042 ,0.0326, 0.0220, 0.1179, 0.7552, 0.0321, 0.0141, 0.0034, 0.0142 ,0.0016, 0.0006, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0009)
moodys[12,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0001, 0.0007 ,0.0028, 0.0038, 0.0495, 0.0878, 0.7420, 0.0287, 0.0337, 0.0309, 0.0155, 0.0027, 0.0004, 0.0004, 0.0001, 0.0000, 0.0009)
moodys[13,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0001, 0.0011, 0.0008, 0.0068, 0.0524, 0.0971, 0.6316, 0.1427, 0.0532, 0.0101, 0.0024, 0.0002, 0.0002, 0.0001, 0.0000, 0.0010)
moodys[14,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0001, 0.0001, 0.0001, 0.0014, 0.0048, 0.0409, 0.0684, 0.7246, 0.0910, 0.0536, 0.0092, 0.0014, 0.0013, 0.0004, 0.0000, 0.0028)
moodys[15,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0010, 0.0000, 0.0000, 0.0002, 0.0020, 0.0051, 0.0262, 0.1322, 0.6266, 0.1164, 0.0548, 0.0042, 0.0039, 0.0019, 0.0000, 0.0254)
moodys[16,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0001, 0.0014, 0.0000, 0.0000, 0.0001, 0.0015, 0.0013, 0.0044, 0.0452, 0.1516, 0.5347, 0.1542, 0.0321, 0.0281, 0.0111, 0.0000, 0.0342)
moodys[17,1:22] <- c(0.0000 ,0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0001 ,0.0000 ,0.0000, 0.0000, 0.0002, 0.0003, 0.0021, 0.0134, 0.1117, 0.1038, 0.6536, 0.0390, 0.0343, 0.0369, 0.0000 ,0.0045)
moodys[18,1:22] <- c(0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0001, 0.0000, 0.0000, 0.0000, 0.0001, 0.0001, 0.0004, 0.0042, 0.0232, 0.1068, 0.1417, 0.6124, 0.0147, 0.0933 ,0.0000 ,0.0031)
moodys[19,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000 ,0.0000 ,0.0003, 0.0018, 0.0221, 0.0222, 0.2634, 0.0285 ,0.4742 ,0.1869, 0.0000, 0.0006)
moodys[20,1:22] <- c(0.0000, 0.0000 ,0.0000 ,0.0000, 0.0000, 0.0000 ,0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0003 ,0.0020, 0.0230, 0.0304 ,0.2602, 0.1173, 0.1018, 0.4641, 0.0000 ,0.0008)
moodys[21,1:22] <- c(0.0000 ,0.0000, 0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0000 ,0.0000, 0.0000 ,0.0000 ,1.0000, 0.0000)
moodys[22,1:22] <- c(0.0000, 0.0000, 0.0000 ,0.0009 ,0.0010 ,0.0045, 0.0633, 0.0021, 0.0009 ,0.0047 ,0.0612, 0.0013, 0.0007 ,0.0018, 0.0071, 0.0514, 0.0066, 0.0013, 0.0012 ,0.0003, 0.0000, 0.7896)


fitch <- matrix(0, nrow=22, ncol=22)
fitch[1,1:22] <- c(0.9924,0.0074,0.0001,0.0001,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000)
fitch[2,1:22]<-c(0.1490,0.8095,0.0211,0.0199,0.0005,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000)
fitch[3,1:22]<-c(0.0083,0.0947,0.8676,0.0287,0.0007,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000)
fitch[4,1:22]<-c(0.0003,0.0060,0.1088,0.8416,0.0409,0.0022,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000)
fitch[5,1:22]<-c(0.0000,0.0003,0.0086,0.1322,0.7709,0.0857,0.0000,0.0000,0.0002,0.0019,0.0001,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000)
fitch[6,1:22]<-c(0.0000,0.0000,0.0005,0.0123,0.1453,0.8002,0.0001,0.0004,0.0047,0.0336,0.0021,0.0004,0.0000,0.0001,0.0000,0.0003,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000)
fitch[7,1:22]<-c(0.0000,0.0000,0.0000,0.0005,0.0098,0.1078,0.8516,0.0276,0.0002,0.0023,0.0001,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000)
fitch[8,1:22]<-c(0.0000,0.0000,0.0000,0.0002,0.0040,0.0487,0.2975,0.6485,0.0001,0.0009,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000)
fitch[9,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0004,0.0067,0.0572,0.1785,0.7016,0.0325,0.0021,0.0005,0.0027,0.0151,0.0015,0.0011,0.0001,0.0000,0.0000,0.0000,0.0000,0.0000)
fitch[10,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0006,0.0060,0.0249,0.1911,0.6531,0.0860,0.0171,0.0018,0.0032,0.0016,0.0129,0.0004,0.0003,0.0007,0.0000,0.0000,0.0001)
fitch[11,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0001,0.0007,0.0030,0.0293,0.1252,0.7594,0.0512,0.0155,0.0120,0.0013,0.0019,0.0001,0.0000,0.0001,0.0000,0.0000,0.0002)
fitch[12,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0001,0.0005,0.0058,0.0378,0.1106,0.7618,0.0720,0.0075,0.0014,0.0016,0.0001,0.0000,0.0001,0.0000,0.0000,0.0009)
fitch[13,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0006,0.0044,0.0267,0.1218,0.6518,0.1207,0.0280,0.0269,0.0015,0.0005,0.0013,0.0001,0.0000,0.0156)
fitch[14,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0001,0.0005,0.0049,0.0200,0.2127,0.5717,0.1128,0.0635,0.0054,0.0015,0.0033,0.0003,0.0001,0.0030)
fitch[15,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0002,0.0032,0.0041,0.0542,0.1806,0.5568,0.1387,0.0391,0.0081,0.0077,0.0022,0.0005,0.0045)
fitch[16,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0004,0.0020,0.0234,0.0013,0.0091,0.0421,0.1394,0.6280,0.0400,0.0272,0.0731,0.0064,0.0008,0.0068)
fitch[17,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0002,0.0035,0.0001,0.0008,0.0054,0.0222,0.2058,0.4376,0.1522,0.0108,0.0370,0.0072,0.1170)
fitch[18,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0003,0.0051,0.0002,0.0013,0.0079,0.0319,0.2801,0.0091,0.6464,0.0156,0.0010,0.0001,0.0008)
fitch[19,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0001,0.0000,0.0000,0.0002,0.0008,0.0143,0.0002,0.0001,0.8194,0.0767,0.0052,0.0828)
fitch[20,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0001,0.0024,0.0001,0.0005,0.0035,0.0153,0.1849,0.0044,0.0026,0.0073,0.1402,0.0113,0.6275)
fitch[21,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0003,0.0050,0.0002,0.0012,0.0076,0.0313,0.2917,0.0090,0.0055,0.0152,0.0010,0.0001,0.6320)
fitch[22,1:22]<-c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0001,0.0003,0.0056,0.0002,0.0014,0.0087,0.0349,0.3040,0.0100,0.0062,0.0171,0.0011,0.0002,0.6102)


snp<-matrix(0,nrow=22,ncol=22)
snp[1,1:22] <- c(0.9789, 0.0207, 0.0003, 0.0001 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000 )
snp[2,1:22] <- c(0.0795, 0.8822, 0.0279, 0.0102 ,0.0002 ,0.0000 ,0.0000 ,0.0000, 0.0000 ,0.0000 ,0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000)
snp[3,1:22] <- c(0.0049, 0.1091, 0.8179, 0.0664, 0.0016 ,0.0001 ,0.0000, 0.0000 ,0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000 ,0.0000, 0.0000)
snp[4,1:22] <- c(0.0002, 0.0080 ,0.1220 ,0.8274 ,0.0391, 0.0027, 0.0006, 0.0000, 0.0000 ,0.0000, 0.0000 ,0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000)
snp[5,1:22] <- c(0.0000 ,0.0003, 0.0079 ,0.1047, 0.7566 ,0.1067, 0.0229, 0.0005 ,0.0002 ,0.0002, 0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000 ,0.0000)
snp[6,1:22] <- c(0.0000 ,0.0000 ,0.0004, 0.0077 ,0.1140, 0.8399, 0.0368, 0.0008, 0.0003, 0.0003, 0.0000 ,0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000)
snp[7,1:22] <- c(0.0000, 0.0000, 0.0001, 0.0012 ,0.0197, 0.1137 ,0.8047, 0.0344 ,0.0129, 0.0128, 0.0004, 0.0001 ,0.0000 ,0.0001 ,0.0000, 0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000 ,0.0000)
snp[8,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0002, 0.0046 ,0.0416, 0.2638 ,0.6402 ,0.0243, 0.0242, 0.0009, 0.0002, 0.0000 ,0.0001 ,0.0000 ,0.0000, 0.0000 ,0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000)
snp[9,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0000, 0.0006, 0.0062 ,0.0525, 0.1997, 0.6709 ,0.0667, 0.0024, 0.0005, 0.0001, 0.0004, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000 ,0.0000)
snp[10,1:22] <- c(0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0004, 0.0043, 0.0222, 0.1503, 0.7464, 0.0536 ,0.0111, 0.0019, 0.0081, 0.0013 ,0.0004 ,0.0000, 0.0000 ,0.0000, 0.0000 ,0.0000 ,0.0000)
snp[11,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0002, 0.0015, 0.0149, 0.1443, 0.7455, 0.0616, 0.0146, 0.0038, 0.0123, 0.0010 ,0.0001, 0.0001, 0.0000, 0.0000 ,0.0000 ,0.0001)
snp[12,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000 ,0.0002 ,0.0020, 0.0236, 0.1211, 0.7461, 0.0712 ,0.0191, 0.0145, 0.0016, 0.0001, 0.0001 ,0.0000 ,0.0000 ,0.0000 ,0.0002)
snp[13,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000, 0.0000, 0.0002 ,0.0037 ,0.0327, 0.0969, 0.6931 ,0.1386, 0.0262, 0.0072, 0.0004 ,0.0003, 0.0001 ,0.0001, 0.0000 ,0.0004)
snp[14,1:22] <- c(0.0000 ,0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000, 0.0000, 0.0001 ,0.0016 ,0.0158, 0.0229, 0.1546, 0.6033, 0.1295 ,0.0589, 0.0048, 0.0030, 0.0010, 0.0007 ,0.0000 ,0.0037)
snp[15,1:22] <- c(0.0000 ,0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000 ,0.0001, 0.0016, 0.0021, 0.0175 ,0.1410 ,0.6915, 0.1053, 0.0095, 0.0089, 0.0039 ,0.0025, 0.0000 ,0.0160)
snp[16,1:22] <- c(0.0000, 0.0000 ,0.0000 ,0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0001, 0.0002, 0.0015, 0.0185 ,0.1722 ,0.5725 ,0.0942 ,0.0388, 0.0208 ,0.0151 ,0.0000, 0.0660)
snp[17,1:22] <- c(0.0000 ,0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0002, 0.0035, 0.0491, 0.2426, 0.4649, 0.0339, 0.0175 ,0.0314, 0.0000, 0.1568)
snp[18,1:22] <- c(0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000 ,0.0000, 0.0003, 0.0048, 0.0667, 0.2283, 0.0491, 0.0756, 0.1540, 0.0850 ,0.0000, 0.3361)
snp[19,1:22] <- c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000, 0.0003 ,0.0044 ,0.0626, 0.1754, 0.0494, 0.0072, 0.2260 ,0.0846, 0.0000 ,0.3901)
snp[20,1:22] <- c(0.0000 ,0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0001, 0.0001, 0.0006 ,0.0091, 0.1098, 0.2901 ,0.0833, 0.0135, 0.0041 ,0.0480, 0.0000, 0.4415)
snp[21,1:22] <- c(0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000 ,0.0000 ,0.0000 ,0.0000 ,0.0000 ,0.0000, 0.0000, 0.0000, 0.0000 ,0.0000, 0.0000, 1.0000 ,0.0000)
snp[22, 1:22] <- c(0.0000, 0.0000 ,0.0000 ,0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0001 ,0.0001 ,0.0012 ,0.0153, 0.1489 ,0.3560 ,0.1055 ,0.0196 ,0.0072 ,0.0075 ,0.0000 ,0.3385)



Q <- c(1,2,5,8,11,14,17,20,22,23)

#Q=c(1,6,10,15,19,23)
C=rep(1,22)
B=rep(1,22)

moodys_lump <- lumpability_2(22,Q,C,B,moodys)
moodys_lumpable <- round(dykstralg(moodys, 60, Q,C,B),4)
fitch_lump <- lumpability_2(22,Q,C,B,fitch)
fitch_lumpable <- round(dykstralg(fitch, 60, Q,C,B),4)
snp_lump <- lumpability_2(22,Q,C,B,snp)
snp_lumpable <- round(dykstralg(snp, 60, Q,C,B),4)

#V<-cbind(c(1,0,0,0,0,0,0,0,0),c(0,0,0,1,1,0,0,0,0,0),c(0,0,0,0,0,1,1,1,0,0),c(0,0,0,0,0,0,0,0,1,1))
V <- matrix(0,ncol=9,nrow=22)
V[,1] <- c(1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
V[,2] <- c(0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
V[,3] <- c(0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
V[,4] <- c(0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0)
V[,5] <- c(0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0)
V[,6] <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0)
V[,7] <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0)
V[,8] <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0)
V[,9] <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1)

U <- t(V)
for (i in 1:9) {U[i,] <- U[i,]/sum(U[i,])}

Pmoodys <- round(U%*%moodys_lumpable%*%V,4)
Pfitch <- round(U%*%fitch_lumpable%*%V,4)
Psnp <- round(U%*%snp_lumpable%*%V,4)

Qfinal <- c(1,4,9,10)
Cfinal <- rep(1,9)
Bfinal <- rep(1,9)
moodys_ifrs <- round(dykstralg(Pmoodys, 60, Qfinal,Cfinal,Bfinal),4)
fitch_ifrs <- round(dykstralg(Pfitch, 60, Qfinal,Cfinal,Bfinal),4)
snp_ifrs <- round(dykstralg(Psnp, 60, Qfinal,Cfinal,Bfinal),4)
Vifrs <- matrix(0,ncol=3,nrow=9)
Vifrs[,1] <- c(1,1,1,0,0,0,0,0,0)
Vifrs[,2] <- c(0,0,0,1,1,1,1,1,0)
Vifrs[,3] <- c(0,0,0,0,0,0,0,0,1)
Uifrs <- t(Vifrs)
for (i in 1:3) {Uifrs[i,] <- Uifrs[i,]/sum(Uifrs[i,])}
moodys_ifrs_lumped <- round(Uifrs%*%moodys_ifrs%*%Vifrs,4)
fitch_ifrs_lumped <- round(Uifrs%*%fitch_ifrs%*%Vifrs,4)
snp_ifrs_lumped <- round(Uifrs%*%snp_ifrs%*%Vifrs,4)
###############################################################################################

for (i in 1:(length(Q)-1)) {V[Q[i]:Q[i+1]-1,i] <-1}

U <- rbind(c(1/3,1/3,1/3,0,0,0,0,0,0,0),c(0,0,0,1/2,1/2,0,0,0,0,0),c(0,0,0,0,0,1/3,1/3,1/3,0,0),c(0,0,0,0,0,0,0,0,1/2,1/2))


PA <- matrix(runif(25,0,1),ncol=5)
for ( i in 1:5) {PA[i,] <- PA[i,]/sum(PA[i,])}
PA[5,] <- c(0,0,0,0,1)

PB <- matrix(runif(25,0,1),ncol=5)
for ( i in 1:5) {PB[i,] <- PB[i,]/sum(PB[i,])}
PB[5,] <- c(0,0,0,0,1)

Q=c(1,2,5,6)
C=rep(1,5)
B=rep(1,5)
PA_lump <- lumpability_2(5,Q,C,B,PA)
PA_lump <- dykstralg(PA, 60, Q,C,B)
PB_lump <- lumpability_2(5,Q,C,B,PB)
PB_lump <- dykstralg(PB, 60, Q,C,B)

V <- matrix(0,ncol=3,nrow=5)
for (i in 1:(length(Q)-1)) {V[Q[i]:Q[i+1]-1,i] <-1}
V[1,2] <- 0
V[4,3] <- 0
U <- t(V)
U[2,] <- U[2,] * 1/3

Pal <- U%*%PA_lump%*%V
Pbl <- U%*%PB_lump%*%V 

fund <- function(w)
{
  #w1 <- w[1]
  #wa <- w[2]
  #wb <- w[3]
  portfolio <- w*Pal+(1-w)*Pbl
  Qportf <- portfolio[1:2,1:2]
  #Qportf[1,] <- wa*Qportf[1,1] + (1-wa)*Qportf[1,2]
  #Qportf[2,] <- wb*Qportf[2,1] + (1-wb)*Qportf[2,2]
  fundamental <- solve((diag(2)-Qportf))
  #fundamental <- solve((diag(2)-Qportf))%*%c(0.04, 0.01)
  
  return(fundamental[1,1]+fundamental[1,2])
}

optimize(fund,c(0,1),maximum =TRUE)

r_new <- c(0.5, 0.3, 0.1)
r <- c(0.1,0.2,0.3)
ret <- (0.25)
a <- c(0.90, 0.80, 0.70)
b <- 2
optimalportf(r,a,ret,b)

p <- rbind(c(0.05,0.1),c(0.15,0.25),c(0.05,0.1))
optimalportf(r,a,ret,b,p)

#optimalportf <- function(r,a,ret,b,p)
optimalportf <- function(r,a,ret,b)  
{
  a1 <- a[1]
  a2<- a[2]
  a3 <- a[3]
  beta <- (ret-r[1])/(r[2]-r[1])
  gamma <- (r[3]-r[1])/(r[2]-r[1])
  delta <- (r[2]-ret)/(r[2]-r[1])
  epsilon <- (r[3]-r[2])/(r[2]-r[1])
  p1 <- 0.0905 #sum(p[1,])
  p2 <- 0.1808 #sum(p[2,])
  p3 <- 0.1027 #sum(p[3,])
  
  
  first2 <- p1*b*a1^2*epsilon^2
  first1 <- p1*(2*b*a1^2*delta*epsilon - epsilon)
  second2 <- p2*b*a2^2*gamma^2
  second1 <- p2*(gamma-2*b*a2^2*beta*gamma)
  third2 <- b*p3*a3^2
  third1 <- -p3
  
  term2 <- first2+second2+third2
  term1 <- first1+second1+third1
    
 opt <- -term1/(2*term2)
  return(c(delta+epsilon*opt,beta-gamma*opt,opt))
}



#f

0.9924&0.0076&0.0000&0.0000&0.0000&0.0000&0.0000&0.0000&0.0000 \\
0.0505&0.9283&0.0212&0.0000&0.0000&0.0000&0.0000&0.0000&0.0000\\
0.0000&0.0695&0.9129&0.0176&0.0000&0.0000&0.0000&0.0000&0.0000\\
0.0000&0.0000&0.1759&0.7881&0.0359&0.0000&0.0000&0.0000&0.0000\\
0.0000&0.0000&0.0000&0.0790&0.8471&0.0716&0.0000&0.0000&0.0023\\
0.0000&0.0000&0.0000&0.0000&0.1403&0.8005&0.0579&0.0000&0.0012\\
0.0000&0.0000&0.0000&0.0000&0.0000&0.1956&0.7215&0.0295&0.0533\\
0.0000&0.0000&0.0000&0.0000&0.0009&0.2686&0.0136&0.0901&0.6269\\
0.0000&0.0000&0.0000&0.0004&0.0072&0.3476&0.0333&0.0013&0.6102\\
#snp

0.9789&0.0211&0.0000&0.0000&0.0000&0.0000&0.0000&0.0000&0.0000\\
0.0266&0.9523&0.0209&0.0000&0.0000&0.0000&0.0000&0.0000&0.0000\\
0.0000&0.0581&0.9273&0.0145&0.0000&0.0000&0.0000&0.0000&0.0000\\
0.0000&0.0000&0.1556&0.8268&0.0175&0.0000&0.0000&0.0000&0.0000\\
0.0000&0.0000&0.0000&0.0798&0.8394&0.0808&0.0000&0.0000&0.0000\\
0.0000&0.0000&0.0000&0.0000&0.0917&0.8214&0.0577&0.0037&0.0254\\
0.0000&0.0000&0.0000&0.0000&0.0000&0.2661&0.3795&0.0664&0.2879\\
0.0000&0.0000&0.0000&0.0000&0.0000&0.1659&0.0108&0.6368&0.1864\\
0.0000&0.0000&0.0000&0.0000&0.0014&0.5202&0.1323&0.0075&0.3385\\




 